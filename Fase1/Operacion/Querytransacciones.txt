SELECT CLIENTECODIGO, ADCLAFAM, FRECUENCIA  
FROM
(
SELECT *
,TRIM(TO_CHAR(FAMILIA,'000')) AS FAM
,TRIM(TO_CHAR(CLASE,'00')) AS CLAS
,TRIM(TO_CHAR(AREA,'0')) AS AREA
,(AREA||DEPARTAMENTO||CLAS||FAM) AS ADCLAFAM
FROM
(
SELECT  CLIENTECODIGO,CLASE, FAMILIA, DEPARTAMENTO
,SUM(CASE WHEN CLASE>'0' THEN 1 ELSE 0 END) AS FRECUENCIA
,MAX(CASE WHEN CARTERA='Ropa' THEN 1  WHEN CARTERA='Muebles' THEN 2 WHEN CARTERA='Prestamos' THEN 3 ELSE 0 END) AS AREA
FROM
(
SELECT *
,CASE WHEN CLASE>'0' THEN 1 ELSE 0 END AS T_CLASE
,CASE WHEN FAMILIA>'0' THEN 1 ELSE 0 END AS T_FAMILIA
FROM
DIRECCIONRIESGOS.ADMIN.TRANSACCIONESCARTERAS
where FECHACORTE between '2017-01-31' and '2019-12-31' and CLIENTECODIGO not in (9001,9000) AND CLIENTECODIGO >10000---Realizar Cambio dependiendo la FechaCorte correspondiente--
) E
GROUP BY CLIENTECODIGO, CLASE, FAMILIA, DEPARTAMENTO
ORDER BY CLIENTECODIGO
) T
WHERE CLASE NOT IN (-99)
) P
ORDER BY CLIENTECODIGO,ADCLAFAM 